'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var ee = require('axios');
var Q = require('zod');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var ee__default = /*#__PURE__*/_interopDefaultLegacy(ee);
var Q__default = /*#__PURE__*/_interopDefaultLegacy(Q);

function D(o,e){let t={...o};for(let i of e)delete t[i];return t}function B(o){return o.charAt(0).toUpperCase()+o.slice(1)}var q=/:([a-zA-Z_][a-zA-Z0-9_]*)/g;function M(o){let e=o.url,t=o.params;return t&&(e=e.replace(q,(i,n)=>n in t?`${t[n]}`:i)),e}function P(o,e,t){return o.find(i=>i.method===e&&i.path===t)}function U(o,e){return o.find(t=>t.alias===e)}function $(o,e){var i,n;let t=(i=o.errors)==null?void 0:i.filter(s=>s.status===e.response.status);return t&&t.length>0?t:(n=o.errors)==null?void 0:n.filter(s=>s.status==="default")}function O(o,e,t,i){let n=P(o,e,t);return n&&i.config&&i.config.url&&n.method===i.config.method&&k(n.path,i.config.url)?$(n,i):void 0}function b(o,e,t){let i=U(o,e);return i&&t.config&&t.config.url&&i.method===t.config.method&&k(i.path,t.config.url)?$(i,t):void 0}function k(o,e){return new RegExp(`^${o.replace(q,()=>"([^/]*)")}$`).test(e)}function C(o){let e=new FormData;for(let t in o)e.append(t,o[t]);return {data:e}}var u=class extends Error{constructor(t,i,n,s){super(t);this.config=i;this.data=n;this.cause=s;}};var H={name:"form-data",request:async(o,e)=>{if(typeof e.data!="object"||Array.isArray(e.data))throw new u("Zodios: multipart/form-data body must be an object",e);let t=C(e.data);return {...e,data:t.data,headers:{...e.headers,...t.headers}}}};function E(){return H}var F={name:"form-url",request:async(o,e)=>{if(typeof e.data!="object"||Array.isArray(e.data))throw new u("Zodios: application/x-www-form-urlencoded body must be an object",e);return {...e,data:new URLSearchParams(e.data).toString(),headers:{...e.headers,"Content-Type":"application/x-www-form-urlencoded"}}}};function R(){return F}function Z(o,e){return {request:async(t,i)=>({...i,headers:{...i.headers,[o]:e}})}}function v(o){return [!0,"response","all"].includes(o)}function S(o){return [!0,"request","all"].includes(o)}function T({validate:o,transform:e,sendDefaults:t}){return {name:"zod-validation",request:S(o)?async(i,n)=>{let s=P(i,n.method,n.url);if(!s)throw new Error(`No endpoint found for ${n.method} ${n.url}`);let{parameters:a}=s;if(!a)return n;let d={...n,queries:{...n.queries},headers:{...n.headers},params:{...n.params}},m={Query:p=>{var r;return (r=d.queries)==null?void 0:r[p]},Body:p=>d.data,Header:p=>{var r;return (r=d.headers)==null?void 0:r[p]},Path:p=>{var r;return (r=d.params)==null?void 0:r[p]}},h={Query:(p,r)=>d.queries[p]=r,Body:(p,r)=>d.data=r,Header:(p,r)=>d.headers[p]=r,Path:(p,r)=>d.params[p]=r},K=S(e);for(let p of a){let{name:r,schema:j,type:g}=p,x=m[g](r);if(t||x!==void 0){let A=await j.safeParseAsync(x);if(!A.success)throw new u(`Zodios: Invalid ${g} parameter '${r}'`,n,x,A.error);K&&h[g](r,A.data);}}return d}:void 0,response:v(o)?async(i,n,s)=>{var d,m;let a=P(i,n.method,n.url);if(!a)throw new Error(`No endpoint found for ${n.method} ${n.url}`);if((m=(d=s.headers)==null?void 0:d["content-type"])!=null&&m.includes("application/json")){let h=await a.response.safeParseAsync(s.data);if(!h.success)throw new u(`Zodios: Invalid response from endpoint '${a.method} ${a.path}'
status: ${s.status} ${s.statusText}
cause:
${h.error.message}
received:
${JSON.stringify(s.data,null,2)}`,n,s.data,h.error);v(e)&&(s.data=h.data);}return s}:void 0}}var l=class{constructor(e,t){this.plugins=[];this.key=`${e}-${t}`;}indexOf(e){return this.plugins.findIndex(t=>(t==null?void 0:t.name)===e)}use(e){if(e.name){let t=this.indexOf(e.name);if(t!==-1)return this.plugins[t]=e,{key:this.key,value:t}}return this.plugins.push(e),{key:this.key,value:this.plugins.length-1}}eject(e){if(typeof e=="string"){let t=this.indexOf(e);if(t===-1)throw new Error(`Plugin with name '${e}' not found`);this.plugins[t]=void 0;}else {if(e.key!==this.key)throw new Error(`Plugin with key '${e.key}' is not registered for endpoint '${this.key}'`);this.plugins[e.value]=void 0;}}async interceptRequest(e,t){let i=t;for(let n of this.plugins)n!=null&&n.request&&(i=await n.request(e,i));return i}async interceptResponse(e,t,i){let n=i;for(let s=this.plugins.length-1;s>=0;s--){let a=this.plugins[s];a&&(n=n.then(a!=null&&a.response?d=>a.response(e,t,d):void 0,a!=null&&a.error?d=>a.error(e,t,d):void 0));}return n}count(){return this.plugins.reduce((e,t)=>t?e+1:e,0)}};function c(o){let e=new Set;for(let i of o){let n=`${i.method} ${i.path}`;if(e.has(n))throw new Error(`Zodios: Duplicate path '${n}'`);e.add(n);}let t=new Set;for(let i of o)if(i.alias){if(t.has(i.alias))throw new Error(`Zodios: Duplicate alias '${i.alias}'`);t.add(i.alias);}for(let i of o)if(i.parameters&&i.parameters.filter(s=>s.type==="Body").length>1)throw new Error(`Zodios: Multiple body parameters in endpoint '${i.path}'`)}function I(o){return c(o),o}function L(o){return o}function _(){return new y([])}var y=class{constructor(e){this.params=e;}addParameter(e,t,i){return new y([...this.params,{name:e,type:t,description:i.description,schema:i}])}addParameters(e,t){let i=Object.keys(t).map(n=>({name:n,type:e,description:t[n].description,schema:t[n]}));return new y([...this.params,...i])}addBody(e){return this.addParameter("body","Body",e)}addQuery(e,t){return this.addParameter(e,"Query",t)}addPath(e,t){return this.addParameter(e,"Path",t)}addHeader(e,t){return this.addParameter(e,"Header",t)}addQueries(e){return this.addParameters("Query",e)}addPaths(e){return this.addParameters("Path",e)}addHeaders(e){return this.addParameters("Header",e)}build(){return this.params}};function V(o){return o}function G(o){return o}var f=class{constructor(e){this.api=e;}addEndpoint(e){return new f([...this.api,e])}build(){return c(this.api),this.api}};function J(o){return new f([o])}function W(o,e){let t=B(o);return I([{method:"get",path:`/${o}s`,alias:`get${t}s`,description:`Get all ${o}s`,response:Q__default["default"].array(e)},{method:"get",path:`/${o}s/:id`,alias:`get${t}`,description:`Get a ${o}`,response:e},{method:"post",path:`/${o}s`,alias:`create${t}`,description:`Create a ${o}`,parameters:[{name:"body",type:"Body",description:"The object to create",schema:e.partial()}],response:e},{method:"put",path:`/${o}s/:id`,alias:`update${t}`,description:`Update a ${o}`,parameters:[{name:"body",type:"Body",description:"The object to update",schema:e}],response:e},{method:"patch",path:`/${o}s/:id`,alias:`patch${t}`,description:`Patch a ${o}`,parameters:[{name:"body",type:"Body",description:"The object to patch",schema:e.partial()}],response:e},{method:"delete",path:`/${o}s/:id`,alias:`delete${t}`,description:`Delete a ${o}`,response:e}])}function X(o){return o.endsWith("/")?o.slice(0,-1):o}function z(o,e){return e.map(t=>({...t,path:X(`${o}${t.path}`)}))}function Y(o){return Object.keys(o).flatMap(e=>z(e,o[e]))}var w=class{constructor(e,t,i){this.endpointPlugins=new Map;let n;if(!e)throw Array.isArray(t)?new Error("Zodios: missing base url"):new Error("Zodios: missing api description");let s;if(typeof e=="string"&&Array.isArray(t))s=e,this.api=t,n=i||{};else if(Array.isArray(e)&&!Array.isArray(t))this.api=e,n=t||{};else throw new Error("Zodios: api must be an array");c(this.api),this.options={validate:!0,transform:!0,sendDefaults:!1,...n},this.options.axiosInstance?this.axiosInstance=this.options.axiosInstance:this.axiosInstance=ee__default["default"].create({...this.options.axiosConfig}),s&&(this.axiosInstance.defaults.baseURL=s),this.injectAliasEndpoints(),this.initPlugins(),[!0,"all","request","response"].includes(this.options.validate)&&this.use(T(this.options));}initPlugins(){this.endpointPlugins.set("any-any",new l("any","any")),this.api.forEach(e=>{let t=new l(e.method,e.path);switch(e.requestFormat){case"binary":t.use(Z("Content-Type","application/octet-stream"));break;case"form-data":t.use(E());break;case"form-url":t.use(R());break;case"text":t.use(Z("Content-Type","text/plain"));break}this.endpointPlugins.set(`${e.method}-${e.path}`,t);});}getAnyEndpointPlugins(){return this.endpointPlugins.get("any-any")}findAliasEndpointPlugins(e){let t=this.api.find(i=>i.alias===e);if(t)return this.endpointPlugins.get(`${t.method}-${t.path}`)}findEnpointPlugins(e,t){return this.endpointPlugins.get(`${e}-${t}`)}get baseURL(){return this.axiosInstance.defaults.baseURL}get axios(){return this.axiosInstance}use(...e){if(typeof e[0]=="object")return this.getAnyEndpointPlugins().use(e[0]);if(typeof e[0]=="string"&&typeof e[1]=="object"){let t=this.findAliasEndpointPlugins(e[0]);if(!t)throw new Error(`Zodios: no alias '${e[0]}' found to register plugin`);return t.use(e[1])}else if(typeof e[0]=="string"&&typeof e[1]=="string"&&typeof e[2]=="object"){let t=this.findEnpointPlugins(e[0],e[1]);if(!t)throw new Error(`Zodios: no endpoint '${e[0]} ${e[1]}' found to register plugin`);return t.use(e[2])}throw new Error("Zodios: invalid plugin registration")}eject(e){var t;if(typeof e=="string"){this.getAnyEndpointPlugins().eject(e);return}(t=this.endpointPlugins.get(e.key))==null||t.eject(e);}injectAliasEndpoints(){this.api.forEach(e=>{e.alias&&(["post","put","patch","delete"].includes(e.method)?this[e.alias]=(t,i)=>this.request({...i,method:e.method,url:e.path,data:t}):this[e.alias]=t=>this.request({...t,method:e.method,url:e.path}));});}async request(e){let t=e,i=this.getAnyEndpointPlugins(),n=this.findEnpointPlugins(t.method,t.url);t=await i.interceptRequest(this.api,t),n&&(t=await n.interceptRequest(this.api,t));let s=this.axiosInstance.request({...D(t,["params","queries"]),url:M(t),params:t.queries});return n&&(s=n.interceptResponse(this.api,t,s)),s=i.interceptResponse(this.api,t,s),(await s).data}async get(e,...[t]){return this.request({...t,method:"get",url:e})}async post(e,t,...[i]){return this.request({...i,method:"post",url:e,data:t})}async put(e,t,...[i]){return this.request({...i,method:"put",url:e,data:t})}async patch(e,t,...[i]){return this.request({...i,method:"patch",url:e,data:t})}async delete(e,t,...[i]){return this.request({...i,method:"delete",url:e,data:t})}},te=w;function N(o,e){if(o instanceof ee.AxiosError||o&&typeof o=="object"&&"isAxiosError"in o){let t=o;if(t.response){let i=e(t);if(i)return i.some(n=>n.schema.safeParse(t.response.data).success)}}return !1}function ie(o,e,t,i){return N(i,n=>O(o,e,t,n))}function ne(o,e,t){return N(t,i=>b(o,e,i))}

exports.Zodios = te;
exports.ZodiosError = u;
exports.apiBuilder = J;
exports.checkApi = c;
exports.formDataPlugin = E;
exports.formURLPlugin = R;
exports.headerPlugin = Z;
exports.isErrorFromAlias = ne;
exports.isErrorFromPath = ie;
exports.makeApi = I;
exports.makeCrudApi = W;
exports.makeEndpoint = G;
exports.makeErrors = V;
exports.makeParameters = L;
exports.mergeApis = Y;
exports.parametersBuilder = _;
exports.prefixApi = z;
exports.zodValidationPlugin = T;
